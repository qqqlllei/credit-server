<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>

    <meta content="text/html;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <title>下户预约</title>
    <link rel="stylesheet"  th:href="@{/css/weui.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/example.css}"/>
    <script type="text/javascript" th:src="@{/js/jquery-2.1.4.js}"></script>
    <script type="text/javascript" th:src="@{/js/weui.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jweixin-1.0.0.js}"></script>
</head>
<body>
<div class="weui-tab">
    <div class="weui-cells" >
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>订单编号</p>
            </div>
            <div class="weui-cell__ft bussNo" id="bussNo" th:text="${businessMessage.bussNo}"></div>
        </div>

        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>借款人</p>
            </div>
            <div class="weui-cell__ft bussNo" th:text="${businessMessage.custName}"></div>
        </div>


        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>预约时间</p>
            </div>
            <div class="weui-cell__ft">
                <a th:if="${surveyTime !=null}" th:text="${surveyTime}" href="javascript:;" th:value="${surveyTime}" class="weui-form-preview__btn weui-form-preview__btn_primary" id="selectDate"></a>
                <a href="javascript:;" th:if="${surveyTime == null}"  class="weui-form-preview__btn weui-form-preview__btn_primary" id="selectDate">选择</a>

            </div>
        </div>


    </div>

    <div class="weui-flex">
        <div class="weui-flex__item">
            <div class="placeholder">
                <a th:if="${assignStatus == '00'}" href="javascript:void(0);" id="subscribe" class="weui-btn weui-btn_primary ">预约</a>

                <a th:if="${assignStatus != '00'}" href="javascript:void(0);" class="weui-btn weui-btn_plain-default weui-btn_plain-disabled ">预约</a>

            </div>
        </div>
        <div class="weui-flex__item">
            <div class="placeholder">

                <a th:if="${assignStatus != '00'}" href="javascript:void(0);" id="cancelSubscribe" class="weui-btn weui-btn_primary ">取消预约</a>

                <a th:if="${assignStatus == '00'}" href="javascript:void(0);" class="weui-btn weui-btn_plain-default weui-btn_plain-disabled ">取消预约</a>

            </div>
        </div>
    </div>


    <ul class="weui-media-box__info">
        <li class="weui-media-box__info__meta" style="margin-left: 5px;">提示：调查预约时间范围包含当日在内的三个自然日，预约调查需收取300元下户费，取消预约不退还</li>
    </ul>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    var path ="/"+window.location.pathname.split("/")[1];

//    var date =eval("("+'${date}'+")");

    var date = [[${date}]];

    var day = date.day;
    $('#selectDate').on('click', function () {
        weui.picker(day, [
            {
                label: '09:00',
                value: '09:00:00'
            }, {
                label: '11:00',
                value: '11:00:00'
            }, {
                label: '13:00',
                value: '13:00:00'
            }, {
                label: '15:00',
                value: '15:00:00'
            }, {
                label: '17:00',
                value: '17:00:00'
            }
        ], {
            defaultValue: ['1', 'A'],
            onConfirm: function (result) {
                var selectTime = result[0].label+"  "+result[1].label;
                var selectTimeValue = result[0].value+" "+result[1].value;
                $("#selectDate").html(selectTime);
                $("#selectDate").val(selectTimeValue);
            }
        });

    });

    $("#subscribe").click(function(){

        var bussNo = $("#bussNo").html().trim();
        var time = $("#selectDate").val();
        if(time ==''){
            weui.alert("请选择预约时间");

            return ;
        }



        $.ajax({
            type: 'POST',
            dataType    : 'json',
            url: path+'/survey/subscribe',
            data:{"bussNo":bussNo,"time":time},
            success: function(ret){

                if((ret && ret.resultMsg && ret.resultCode =='0001')){
                    weui.alert(ret.resultMsg);
                }

                if(ret && ret.resultCode =='0000'){
                    weui.toast("预约成功");
                    window.setTimeout(closeWindow,2000);
                }
            },
            error: function(xhr, type){
                weui.alert('系统繁忙，稍后再试!')
            }
        });
    });

    $("#cancelSubscribe").click(function(){
        var bussNo = $("#bussNo").html().trim();

        $.ajax({
            type: 'POST',
            dataType    : 'json',
            url: path+'/survey/cancelSubscribe',
            data:{"bussNo":bussNo},
            success: function(ret){

                if((ret && ret.resultMsg&& ret.resultCode =='0001')){
                    weui.alert(ret.resultMsg);
                }

                if(ret && ret.resultCode =='0000'){
                    weui.toast("取消成功");
                    window.setTimeout(closeWindow,2000);
                }
            },
            error: function(xhr, type){
                weui.alert('系统繁忙，稍后再试!')
            }
        });
    });




    function closeWindow(){
        wx.closeWindow();
    }

    /*]]>*/
</script>
</body>
</html>