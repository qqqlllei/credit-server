<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>

    <meta content="text/html;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no;" />

    <title>外微提单</title>
    <link rel="stylesheet"  th:href="@{/css/weui.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/example.css}"/>
    <link rel="stylesheet" th:href="@{/css/contract.css}"/>
    <script type="text/javascript" th:src="@{/js/jquery-2.1.4.js}"></script>
    <script type="text/javascript" th:src="@{/js/weui.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jweixin-1.0.0.js}"></script>
</head>
<body >
<form method="post" id="form" name="form">


    <input type="hidden" id="token" th:value="${token}" name="token" />
    <div class="weui-tab">
        <div class="weui-navbar">
            <div id="tabFirst" class="weui-navbar__item weui-bar__item_on">
                基本信息
            </div>
            <div id="tabSecend" class="weui-navbar__item ">
                房产信息
            </div>
        </div>
        <div class="weui-tab__panel">
            <div id="pageFirst">
                <div class="weui-tab">
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">借款人姓名</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input"  type="text" id="realName"  />
                        </div>
                    </div>


                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">身份证</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="text" id="idCard" />
                        </div>
                    </div>

                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">所在区域</label></div>
                        <div class="weui-cell__bd">
                            <div class="selectRight" th:text="${area}">

                            </div>
                        </div>
                    </div>


                    <div class="weui-cell" >
                        <div class="weui-cell__hd">
                            <label class="weui-label">机构代码</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" id="channelCode"  />
                        </div>
                    </div>

                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <label class="weui-label">贷款金额</label>
                        </div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" type="number"  id="loanAmount" />
                        </div>
                    </div>


                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <div class="weui_btn_area" >
                                <a href="javascript:void(0);" class="weui-btn weui-order-btn" onclick="gotoNext();">下一步</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="pageSecend" style="display:none">
                <div class=" weui-cells_form" id="uploader">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <div class="weui-uploader">
                                <div class="weui-uploader__hd">
                                    <p class="weui-uploader__title"></p>
                                    <div class="weui-uploader__info"></div>
                                </div>
                                <div class="weui-uploader__bd">
                                    <ul class="weui-uploader__files" id="uploaderFiles"></ul>
                                    <div class="weui-uploader__input-box">
                                        <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple="" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="weui-cell  weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd "><label class="weui-label">房产证类型</label></div>
                    <div class="weui-cell__bd">
                        <div class="selectRight">
                            <select class="weui-select" name="select2" id="ownershipType">
                                <option value="0">旧版</option>
                                <option value="1">新版</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="weui-cell">
                    <div class="weui-cell__hd">
                        <label class="weui-label">房产证号</label>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd" id="oldBJ" style="display: none;">
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">京房权证</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">字第</span>
                        <input  type="text" class="order-input-long" /><span style="color: #a6a5a7;font-size: smaller">号</span>
                    </div>

                    <div class="weui-cell__bd" id="newBJ" style="display: none;">
                        <span style="color: #a6a5a7;font-size: smaller">京(</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">)</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">不动产权第</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">号</span>
                    </div>

                    <div class="weui-cell__bd" id="oldSH" style="display: none;">
                        <span style="color: #a6a5a7;font-size: smaller">沪房地</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">字(</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">)第</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">号</span>
                    </div>

                    <div class="weui-cell__bd" id="newSH" style="display: none;">
                        <span style="color: #a6a5a7;font-size: smaller">沪(</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">)</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">字不动产权第</span>
                        <input  type="text" class="order-input-normal" /><span style="color: #a6a5a7;font-size: smaller">号</span>
                    </div>
                </div>


                <div class="weui-cell  weui-cell_select weui-cell_select-after">
                    <div class="weui-cell__hd "><label class="weui-label">抵押顺位</label></div>
                    <div class="weui-cell__bd">
                        <div class="selectRight">
                            <select class="weui-select" id="pledgeCase" name="select3">
                                <option value="1" selected="selected">一抵</option>
                                <option value="2">二抵</option>
                            </select>
                        </div>
                    </div>
                </div>


                <div class="weui-cell" id="pledgeAmountedInput" style="display: none;">
                    <div class="weui-cell__hd"><label class="weui-label">已抵金额</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" id="pledgeAmounted" type="number"  placeholder="" />
                    </div>
                    <label >万元</label>
                </div>

                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div class="weui_btn_area">
                            <a href="javascript:void(0);" class="weui-btn weui-order-btn" id="submitButton" onclick="submitOrder();">提交</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</form>


<div class="weui-tab__content" id="successDiv">
    <div class="weui-cells weui-cells_form">

        <div class="weui-media-box weui-media-box_text">
            <h4 class="weui-media-box__title"><i class="weui-icon-success"></i>提交成功</h4>
        </div>

        <div class="weui-media-box weui-media-box_text">
            <p class="weui-media-box__desc"></p>
            <h4 class="weui-media-box__title">您的订单已经提交</h4>
        </div>
        <div class="weui-media-box weui-media-box_text">
            <p class="weui-media-box__desc" id="orderNum">订单号</p>
            <p class="weui-media-box__desc">两小时给你反馈</p>
        </div>
    </div>

    <div class="weui-cell">
        <div class="weui-cell__bd">
            <div class="weui_btn_area">
                <a href="javascript:void(0);" id="showMyOrders" class="weui-btn weui-btn_primary">查看我的订单</a>
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">

    /*<![CDATA[*/
    var path ="/"+window.location.pathname.split("/")[1];


    var areaCode=[[${areaCode}]];

    if(areaCode == '001'){
        $("#oldBJ").show();
    }else if(areaCode == '002'){
       $("#oldSH").show();
    }


    $("#ownershipType").change(function () {


        var ownershipType = $("#ownershipType").val();

        if(ownershipType == 0){
            if(areaCode == '001'){
                $("#oldBJ").show();
                $("#newBJ").hide();
            }else if(areaCode == '002'){
                $("#newSH").hide();
                $("#oldSH").show();
            }
        }else if(ownershipType == 1){
            if(areaCode == '001'){
                $("#newBJ").show();
                $("#oldBJ").hide();
            }else if(areaCode == '002'){
                $("#oldSH").hide();
                $("#newSH").show();

            }
        }

    });


    var accessid=[[${accessid}]];
    var encodedPolicy=[[${policy}]];
    var signature=[[${signature}]];
    var host=[[${host}]];

    var dir=[[${dir}]];
    var expireTime=[[${expireTime}]];
    var currentTime=[[${currentTime}]];
    var name = '';
    weui.uploader('#uploader', {
        url:'http://zhongjiaxin1.oss-cn-shanghai.aliyuncs.com',
        auto: true,
        type: 'file',
        fileVal: 'file',
        onBeforeQueued: function onBeforeQueued(files) {
            if (["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0) {
                weui.alert('请上传图片');
                return false;
            }
            if (this.size > 10 * 1024 * 1024) {
                weui.alert('请上传不超过10M的图片');
                return false;
            }
            if (files.length > 5) {
                // 防止一下子选中过多文件
                weui.alert('最多只能上传5张图片，请重新选择');
                return false;
            }
        },
        onBeforeSend: function(data, headers){
            var fileExtension = data.name.substring(data.name.lastIndexOf('.') + 1);
            name = data.name;
            var time = new Date().getTime();
            var key = time+"."+fileExtension;
            this.key = key ;
            var fileSendTime=(new Date()).valueOf();
            if((parseInt(expireTime)*1000) - (fileSendTime-currentTime) <= 3000){
                $.ajax({
                    type: 'POST',
                    dataType    : 'json',
                    url: path+'/order/getOSSPolicyAndSignature',
                    data:data,
                    async: false,
                    success: function(ret){
                        encodedPolicy=ret.policy;
                        signature=ret.signature;
                        currentTime=ret.currentTime;
                    },
                    error: function(xhr, type){
                        weui.alert('系统繁忙，稍后再试!')
                    }
                });
            }

            $.extend(data, {
                'Filename': time,
                'key' : key,
                'policy': encodedPolicy,
                'OSSAccessKeyId': accessid,
                'success_action_status' : '200', //让服务端返回200,不然，默认会返回204
                'signature': signature,
                'host':host,
                'dir':dir
            });
        },
        onSuccess: function onSuccess(ret){
            $("li[data-id='"+ret.dataId+"']").attr('id',ret.key);
            $("li[data-id='"+ret.dataId+"']").attr('name',name);
        },
        onError: function onError(err) {
            weui.alert("上传失败");
        }
    });


    $("#uploaderFiles").on("click", "li", function(e) {
        var target = e.target;
        while (!target.classList.contains('weui-uploader__file') && target) {
            target = target.parentNode;
        }
        if (!target) return;
        var url = target.getAttribute('style') || '';
        var id = target.getAttribute('id');
        if (url) {
            url = url.match(/url\((.*?)\)/)[1].replace(/"/g, '');
        }
        var gallery = weui.gallery(url, {
            className: 'custom-name',
            onDelete: function onDelete() {
                weui.confirm('确定删除该图片？', function () {
                    target.remove();
                    gallery.hide();
                });
            }
        });
    });

    $("#pledgeCase").change(function(){
        var pledgeCase = $("#pledgeCase").val();
        if(pledgeCase == 2){
            $("#pledgeAmountedInput").show();
        }else{
            $("#pledgeAmountedInput").hide();
        }
    });


    $("#showMyOrders").click(function(){
        window.location.href=path+'/order/listView';
    });

    $("#tabFirst").click(function(){
        $(this).addClass("weui-bar__item_on");
        $("#tabSecend").removeClass("weui-bar__item_on");
        $("#pageFirst").show();
        $("#pageSecend").hide();
    });

    $("#tabSecend").click(function(){
        gotoNext();
    });

    function gotoNext(){
        $("#tabSecend").addClass("weui-bar__item_on");
        $("#tabFirst").removeClass("weui-bar__item_on");
        $("#pageSecend").show();
        $("#pageFirst").hide();
    }


    function submitOrder(){

        $("#submitButton").hide();

        var list=$('#uploaderFiles').children('li');
        var indexs='';
        var names = '';
        for(var i=0 ;i<list.length;i++){
            var u =list[i].getAttribute('id');
            var n = list[i].getAttribute('name');
            if(i!=list.length-1) {
                indexs+=u+",";
                names+=n+",";
            }
            if(i==list.length-1) {
                indexs+=u;
                names+=n;
            }
        }







        var pledgeAmounted = $("#pledgeCase").val() == 2?$("#pledgeAmounted").val():"0"; //已抵金额
        var data = {};
        data.realName = $('#realName').val();
        data.idCard=$('#idCard').val();
        data.loanAmount=$('#loanAmount').val();
        data.index = indexs;
        data.name = names;

        var ownershipType = $("#ownershipType").val();


        var ownershipNo="";
        if(areaCode == '001' && ownershipType == 0){ //旧版北京
            var inputs = $("#oldBJ :text");
            ownershipNo =$(inputs[0]).val()+"京房权证"+$(inputs[1]).val()+"字第"+$(inputs[2]).val()+"号";

        }else if(areaCode == '001' && ownershipType == 1){ //新版北京
            var inputs = $("#newBJ :text");
            ownershipNo ="京("+$(inputs[0]).val()+")"+$(inputs[1]).val()+"不动产权第"+$(inputs[2]).val()+"号";
        }else if(areaCode == '002' && ownershipType == 0){//旧版上海
            var inputs = $("#oldSH :text");
            ownershipNo ="沪房地"+$(inputs[0]).val()+"字("+$(inputs[1]).val()+")第"+$(inputs[2]).val()+"号";
        }else if(areaCode == '002' && ownershipType == 1){//新版上海
            var inputs = $("#newSH :text");
            ownershipNo ="沪("+$(inputs[0]).val()+")"+$(inputs[1]).val()+"字不动产权第"+$(inputs[2]).val()+"号";
        }

        data.ownershipNo = ownershipNo;
        data.pledgeCase = $("#pledgeCase").val();
        data.pledgeAmounted = pledgeAmounted;
        data.channelCode = $("#channelCode").val();

        $.ajax({
            type: 'POST',
            dataType    : 'json',
            url: path+'/order/submitOrder',
            data:data,
            success: function(ret){
                if(ret && ret.resultCode =='0000'){
                    if(ret.channelErrorCode == '01'){//渠道区域与经纪人所属区域不一致
                        $("#submitButton").show();
                        weui.alert(ret.resultMsg);
                    }else{
                        $("#form").hide();
                        $('#orderNum').html("订单编号:"+ret.bussNo)
                        $("#successDiv").show();
                        weui.alert(ret.resultMsg);
                    }
                }

                if(ret && ret.resultCode =='0001'){
                    $("#submitButton").show();
                    var allErrors = ret.allErrors;

                    if(allErrors!=null && allErrors.length >0){
                        var errorMessage = "";
                        for(var i=0;i<allErrors.length ; i++){
                            var error = allErrors[i];
                            errorMessage+=error.defaultMessage+'</br>';
                        }
                        weui.alert(errorMessage);
                    }else{
                        weui.alert(ret.resultMsg);
                    }

                }

                if(ret && ret.channelErrorCode == '01'){//渠道区域与经纪人所属区域不一致
                    $("#submitButton").show();
                    weui.alert(ret.resultMsg);
                }

                if(ret && (ret.resultCode =='0002' || ret.resultCode =='0003' || ret.resultCode =='0004' ||ret.resultCode =='0005' )){
                    $("#submitButton").show();
                    weui.alert(ret.resultMsg);
                }

//                if(ret && ret.resultCode =='0002'){
//                    $("#submitButton").show();
//                    weui.alert(ret.resultMsg);
//                }
            },
            error: function(xhr, type){
                weui.alert('系统繁忙，稍后再试!')
            }
        });
    }
    /*]]>*/
</script>

</body>
</html>